<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dragon vs Tiger - MONETRA</title>
    <link rel="stylesheet" href="dragon-tiger-style.css">
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-table">
        <div class="top-bar">
            <div class="user-info">
                <img src="profile.png" alt="Avatar" class="avatar">
                <div class="user-details">
                    <span id="user-name">Player</span>
                    <span id="user-balance" class="balance">...</span>
                </div>
            </div>
            <div class="history-track" id="history-track"></div>
            <div class="menu-buttons">
                <button class="icon-btn" id="home-btn"></button>
                <button class="icon-btn" id="rules-btn">?</button>
            </div>
        </div>

        <div class="main-area">
            <div class="betting-zone dragon-zone" data-bet="dragon">
                <img src="dragon-emblem.png" class="emblem">
                <div class="total-bet" id="dragon-total-bet">0</div>
                <div class="payout-ratio">1 : 1</div>
                <div class="chip-container" id="dragon-chips"></div>
            </div>

            <div class="middle-zone">
                <div class="card-area" id="dragon-card-area"><div class="card-placeholder"></div></div>
                <div class="vs-emblem">
                    <img src="vs-emblem.png">
                    <div class="timer" id="timer">...</div>
                </div>
                <div class="card-area" id="tiger-card-area"><div class="card-placeholder"></div></div>
            </div>

            <div class="betting-zone tiger-zone" data-bet="tiger">
                <img src="tiger-emblem.png" class="emblem">
                <div class="total-bet" id="tiger-total-bet">0</div>
                <div class="payout-ratio">1 : 1</div>
                <div class="chip-container" id="tiger-chips"></div>
            </div>

             <div class="betting-zone tie-zone" data-bet="tie">
                <div class="tie-text">TIE</div>
                <div class="total-bet" id="tie-total-bet">0</div>
                <div class="payout-ratio">8 : 1</div>
                <div class="chip-container" id="tie-chips"></div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="chip-selection">
                <button class="chip-btn active" data-value="20"><img src="chip-20.png"></button>
                <button class="chip-btn" data-value="30"><img src="chip-30.png"></button>
                <button class="chip-btn" data-value="50"><img src="chip-50.png"></button>
                <button class="chip-btn" data-value="100"><img src="chip-100.png"></button>
                <button class="chip-btn" data-value="200"><img src="chip-200.png"></button>
                <button class="chip-btn" data-value="500"><img src="chip-500.png"></button>
                <button class="chip-btn" data-value="1000"><img src="chip-1000.png"></button>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="confirm-btn">Confirm</button>
                <button class="action-btn" id="repeat-btn">Repeat</button>
            </div>
        </div>
    </div>
    
    <div class="result-overlay" id="result-overlay">
        <div class="result-text" id="result-text"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        // --- Firebase & User Setup ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        let userDocRef;
        let gameRoomRef = db.collection('game_rooms').doc('dragon_tiger_1');
        let unsubscribeUser;
        let unsubscribeGame;

        if (!userId) {
            document.body.innerHTML = '<h1>Error: Not Logged In. Access from main app.</h1>';
        } else {
            userDocRef = db.collection('users').doc(userId);
        }
        
        // --- Game State & Elements ---
        let selectedChipValue = 20;
        let currentBets = { dragon: 0, tiger: 0, tie: 0 };
        let lastRoundBets = {};
        let isBettingPhase = false;

        const balanceEl = document.getElementById('user-balance');
        const timerEl = document.getElementById('timer');
        const historyTrackEl = document.getElementById('history-track');
        const dragonTotalBetEl = document.getElementById('dragon-total-bet');
        const tigerTotalBetEl = document.getElementById('tiger-total-bet');
        const tieTotalBetEl = document.getElementById('tie-total-bet');
        const resultOverlay = document.getElementById('result-overlay');
        const resultText = document.getElementById('result-text');
        const confirmBtn = document.getElementById('confirm-btn');

        // --- Event Listeners ---
        document.querySelectorAll('.chip-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedChipValue = parseInt(btn.dataset.value);
            });
        });

        document.querySelectorAll('.betting-zone').forEach(zone => {
            zone.addEventListener('click', () => {
                if (!isBettingPhase) {
                    alert('Betting is closed for this round.');
                    return;
                }
                const betType = zone.dataset.bet;
                placeBet(betType, selectedChipValue);
            });
        });

        confirmBtn.addEventListener('click', confirmBets);
        document.getElementById('repeat-btn').addEventListener('click', repeatLastBets);
        document.getElementById('home-btn').addEventListener('click', () => {
            window.location.href = 'https://shikarinx.github.io/index.html'; 
        });

        // --- Real-time Listeners ---
        if(userDocRef) {
            unsubscribeUser = userDocRef.onSnapshot(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    balanceEl.textContent = `₹${userData.walletBalance || 0}`;
                    document.getElementById('user-name').textContent = userData.name || 'Player';
                }
            });
        }

        unsubscribeGame = gameRoomRef.onSnapshot(doc => {
            if (doc.exists) {
                const roomData = doc.data();
                timerEl.textContent = roomData.timer;
                dragonTotalBetEl.textContent = roomData.totalDragonBet || 0;
                tigerTotalBetEl.textContent = roomData.totalTigerBet || 0;
                tieTotalBetEl.textContent = roomData.totalTieBet || 0;
                isBettingPhase = roomData.state === 'betting';
                
                confirmBtn.disabled = !isBettingPhase;
                
                if (roomData.history) {
                    updateHistoryTrack(roomData.history);
                }

                if (roomData.state === 'dealing') {
                    startDealing(roomData.dragonCard, roomData.tigerCard);
                }
                
                if (roomData.state === 'finished' && roomData.winner) {
                    showResult(roomData.winner);
                }
            }
        });

        // --- Game Functions ---
        function placeBet(type, amount) {
            const currentBalance = parseInt(balanceEl.textContent.replace('₹', ''));
            const totalPendingBets = Object.values(currentBets).reduce((a, b) => a + b, 0);

            if (amount > currentBalance - totalPendingBets) {
                alert('Insufficient balance!');
                return;
            }

            currentBets[type] += amount;
            animateChipDrop(type, amount);
        }

        async function confirmBets() {
            const totalBet = Object.values(currentBets).reduce((a, b) => a + b, 0);
            if (totalBet === 0) return;

            try {
                const gameDoc = await gameRoomRef.get();
                const roundId = gameDoc.data().roundId;

                const batch = db.batch();
                batch.update(userDocRef, { walletBalance: firebase.firestore.FieldValue.increment(-totalBet) });
                batch.update(gameRoomRef, {
                    totalDragonBet: firebase.firestore.FieldValue.increment(currentBets.dragon),
                    totalTigerBet: firebase.firestore.FieldValue.increment(currentBets.tiger),
                    totalTieBet: firebase.firestore.FieldValue.increment(currentBets.tie),
                });
                
                await db.collection('dt_bets').add({
                    userId: userId,
                    roundId: roundId,
                    bets: currentBets,
                    status: 'confirmed',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                lastRoundBets = { ...currentBets };
                currentBets = { dragon: 0, tiger: 0, tie: 0 };
                alert('Bets Confirmed!');
            } catch (error) {
                console.error("Error confirming bets: ", error);
                alert("Could not confirm bets. Please try again.");
            }
        }

        function repeatLastBets() {
            if (!isBettingPhase) {
                alert('Betting is closed for this round.');
                return;
            }
            if (Object.keys(lastRoundBets).length > 0) {
                currentBets = { ...lastRoundBets };
                Object.keys(currentBets).forEach(type => {
                    if(currentBets[type] > 0) {
                        animateChipDrop(type, currentBets[type]);
                    }
                });
                confirmBets();
            } else {
                alert("No previous bets to repeat.");
            }
        }

        function updateHistoryTrack(history) {
            historyTrackEl.innerHTML = '';
            history.slice(-15).forEach(result => {
                const dot = document.createElement('div');
                dot.classList.add('history-dot', result.toLowerCase());
                dot.textContent = result.charAt(0);
                historyTrackEl.appendChild(dot);
            });
        }
        
        function animateChipDrop(type, amount) {
            const chipContainer = document.getElementById(`${type}-chips`);
            const chipImgSrc = `chip-${amount >= 1000 ? 1000 : amount >= 500 ? 500 : amount >= 200 ? 200 : amount >= 100 ? 100 : amount >= 50 ? 50 : amount >= 30 ? 30 : 20}.png`;
            const chip = document.createElement('img');
            chip.src = chipImgSrc;
            chip.classList.add('bet-chip-animation');
            chip.style.left = `${20 + Math.random() * 60}%`;
            chip.style.top = `${20 + Math.random() * 60}%`;
            chipContainer.appendChild(chip);
            setTimeout(() => chip.remove(), 1000);
        }

        function startDealing(dragonCard, tigerCard) {
            const dragonCardArea = document.getElementById('dragon-card-area');
            const tigerCardArea = document.getElementById('tiger-card-area');
            
            dragonCardArea.innerHTML = `<img src="card-back-dragon.png" class="card dealing">`;
            tigerCardArea.innerHTML = `<img src="card-back-tiger.png" class="card dealing">`;
            
            setTimeout(() => {
                dragonCardArea.innerHTML = `<img src="card-${dragonCard}.png" class="card revealed">`;
            }, 1000);
             setTimeout(() => {
                tigerCardArea.innerHTML = `<img src="card-${tigerCard}.png" class="card revealed">`;
            }, 2000);
        }

        function showResult(winner) {
            resultText.textContent = `${winner.toUpperCase()} WINS!`;
            resultText.className = `result-text ${winner.toLowerCase()}`;
            resultOverlay.style.display = 'flex';
            setTimeout(() => {
                resultOverlay.style.display = 'none';
            }, 2500);
        }
    </script>
</body>
</html>
